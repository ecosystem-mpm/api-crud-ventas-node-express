name: API para ventas
on:
  push:
    branches:
      - main

jobs:
  tests:
    runs-on: ubuntu-latest
    name: Test y deploys
    steps:
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
            key: ${{ secrets.KEY }}
            known_hosts: 'unnecessary'

      - name: Adding Known Hosts
        run: ssh-keyscan -p ${{ secrets.PORT }} -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2

      - name: Copy dotenv file
        run: php -r "file_put_contents(__DIR__ . '/.env.production', '${{ secrets.DOT_ENV }}');"


      - name: Enviando al servidor de produccion
        uses: burnett01/rsync-deployments@7.0.1
        with:
          legacy_allow_rsa_hostkeys: true
          remote_key: ${{ secrets.KEY }}
          switches: '-avzh --delete --include="*.env.production" --exclude=".*" --exclude="node_modules"'
          remote_port: ${{ secrets.PORT }}
          path: "./"
          remote_host: ${{ secrets.HOST }}
          remote_user: ${{ secrets.USERNAME }}
          remote_path: ${{ secrets.REMOTE_PATH }}

      - name: Deploying ...
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY}}
          port: ${{ secrets.PORT }}
          script: |
            cd ${{ secrets.REMOTE_PATH }}
            sh update.sh
